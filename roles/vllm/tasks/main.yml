---
- name: Create Hugging Face cache directory
  file:
    path: "{{ huggingface_cache }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Create vLLM deployment manifest
  template:
    src: vllm-deployment.yaml.j2
    dest: "/home/{{ ansible_user }}/vllm-deployment.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy vLLM to Kubernetes
  kubernetes.core.k8s:
    state: present
    src: "/home/{{ ansible_user }}/vllm-deployment.yaml"
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
  become_user: "{{ ansible_user }}"
  register: vllm_deploy

- name: Wait for vLLM pod to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ vllm_namespace }}"
    label_selectors:
      - "app={{ vllm_deployment_name }}"
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
  register: vllm_pods
  until: vllm_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10
  become_user: "{{ ansible_user }}"
  ignore_errors: yes

- name: Display vLLM deployment status
  debug:
    msg:
      - "==========================================="
      - "vLLM Deployment Status"
      - "==========================================="
      - "Pod Status: {{ vllm_pods.resources[0].status.phase if vllm_pods.resources | length > 0 else 'Unknown' }}"
      - ""
      - "To check logs:"
      - "  kubectl logs -l app={{ vllm_deployment_name }} -f"
      - ""
      - "To test the API:"
      - "  curl http://localhost:{{ vllm_port }}/v1/chat/completions \\"
      - "    -H 'Content-Type: application/json' \\"
      - "    -d '{\"model\": \"{{ vllm_model }}\", \"messages\": [{\"role\": \"user\", \"content\": \"Hello!\"}]}'"
      - "==========================================="