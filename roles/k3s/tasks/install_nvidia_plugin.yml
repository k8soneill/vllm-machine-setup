---
- name: Force delete device plugin if requested
  kubernetes.core.k8s:
    state: absent
    api_version: apps/v1
    kind: DaemonSet
    name: nvidia-device-plugin-daemonset
    namespace: kube-system
    kubeconfig: "{{ kubeconfig }}"
  when: gpu_force_recreate | default(false)

- name: Wait for forced deletion to complete
  pause:
    seconds: 10
  when: gpu_force_recreate | default(false)

- name: Create NVIDIA device plugin manifest
  template:
    src: nvidia-device-plugin.yaml.j2
    dest: /tmp/nvidia-device-plugin.yaml
    mode: '0644'

- name: Apply NVIDIA device plugin
  kubernetes.core.k8s:
    state: present
    src: /tmp/nvidia-device-plugin.yaml
    kubeconfig: "{{ kubeconfig }}"
  register: device_plugin_apply

- name: Wait for NVIDIA device plugin pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: kube-system
    label_selectors:
      - name=nvidia-device-plugin-ds
    kubeconfig: "{{ kubeconfig }}"
  register: device_plugin_pods
  until: device_plugin_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 20
  delay: 5

- name: Check device plugin DaemonSet status
  kubernetes.core.k8s_info:
    kind: DaemonSet
    name: nvidia-device-plugin-daemonset
    namespace: kube-system
    kubeconfig: "{{ kubeconfig }}"
  register: device_plugin_ds

- name: Display device plugin status
  debug:
    msg:
      - "Device Plugin Pods Ready: {{ device_plugin_ds.resources[0].status.numberReady | default(0) }}/{{ device_plugin_ds.resources[0].status.desiredNumberScheduled | default(0) }}"
      - "Pod Status: {{ 'Ready ✓' if (device_plugin_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0) else 'Not Ready ✗' }}"

- name: Get device plugin logs if there were issues
  kubernetes.core.k8s_log:
    name: "{{ device_plugin_pods.resources[0].metadata.name }}"
    namespace: kube-system
    kubeconfig: "{{ kubeconfig }}"
    tail_lines: 50
  register: device_plugin_logs
  when: 
    - device_plugin_pods.resources | length > 0
    - device_plugin_pods.resources[0].status.phase != 'Running'
  ignore_errors: yes

- name: Display device plugin logs if there were issues
  debug:
    msg: "{{ device_plugin_logs.log_lines }}"
  when: 
    - device_plugin_logs.log_lines is defined

- name: Clean up device plugin manifest
  file:
    path: /tmp/nvidia-device-plugin.yaml
    state: absent
