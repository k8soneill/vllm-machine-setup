---
- name: Install k3s without systemd (manual mode)
  shell: INSTALL_K3S_SKIP_ENABLE=true INSTALL_K3S_SKIP_START=true INSTALL_K3S_VERSION={{ k3s_version }} /tmp/k3s-install.sh
  args:
    creates: "{{ k3s_install_dir }}/k3s"

- name: Create k3s service script for non-systemd
  copy:
    dest: /usr/local/bin/k3s-service.sh
    mode: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # K3s service management for non-systemd systems (WSL)
      
      K3S_BIN="{{ k3s_install_dir }}/k3s"
      K3S_PID_FILE=/var/run/k3s.pid
      K3S_LOG_FILE=/var/log/k3s.log
      
      start() {
          if [ -f "$K3S_PID_FILE" ] && kill -0 $(cat "$K3S_PID_FILE") 2>/dev/null; then
              echo "k3s is already running"
              return 0
          fi
          
          echo "Starting k3s..."
          nohup "$K3S_BIN" server >> "$K3S_LOG_FILE" 2>&1 &
          echo $! > "$K3S_PID_FILE"
          
          # Wait for k3s to be ready
          for i in {1..30}; do
              if kubectl get nodes >/dev/null 2>&1; then
                  echo "k3s started successfully"
                  return 0
              fi
              sleep 2
          done
          
          echo "k3s failed to start"
          return 1
      }
      
      stop() {
          if [ ! -f "$K3S_PID_FILE" ]; then
              echo "k3s is not running"
              return 0
          fi
          
          echo "Stopping k3s..."
          PID=$(cat "$K3S_PID_FILE")
          if kill -0 "$PID" 2>/dev/null; then
              kill "$PID"
              # Wait for process to die
              for i in {1..10}; do
                  if ! kill -0 "$PID" 2>/dev/null; then
                      break
                  fi
                  sleep 1
              done
              # Force kill if still running
              kill -9 "$PID" 2>/dev/null || true
              rm -f "$K3S_PID_FILE"
              echo "k3s stopped"
          else
              rm -f "$K3S_PID_FILE"
              echo "k3s was not running (stale pid file removed)"
          fi
      }
      
      status() {
          if [ -f "$K3S_PID_FILE" ] && kill -0 $(cat "$K3S_PID_FILE") 2>/dev/null; then
              echo "k3s is running (PID: $(cat $K3S_PID_FILE))"
              return 0
          else
              echo "k3s is not running"
              return 1
          fi
      }
      
      case "$1" in
          start)
              start
              ;;
          stop)
              stop
              ;;
          restart)
              stop
              sleep 2
              start
              ;;
          status)
              status
              ;;
          *)
              echo "Usage: $0 {start|stop|restart|status}"
              exit 1
              ;;
      esac

- name: Check if k3s is already running
  shell: pgrep -f "k3s server" || true
  register: k3s_running
  changed_when: false

- name: Start k3s service manually
  shell: /usr/local/bin/k3s-service.sh start
  when: k3s_running.stdout == ""
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for k3s to be ready (non-systemd)
  shell: kubectl get nodes
  register: k3s_ready
  until: k3s_ready.rc == 0
  retries: 10
  delay: 5
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Add k3s service to bashrc for auto-start
  lineinfile:
    path: "/home/{{ ansible_user }}/.bashrc"
    line: "sudo /usr/local/bin/k3s-service.sh start 2>/dev/null"
    create: yes

- name: Add passwordless sudo for k3s service
  lineinfile:
    path: /etc/sudoers.d/k3s-service
    line: "{{ ansible_user }} ALL=(ALL) NOPASSWD: /usr/local/bin/k3s-service.sh"
    create: yes
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Display k3s service management info
  debug:
    msg:
      - "==========================================="
      - "k3s Service Management (Non-systemd)"
      - "==========================================="
      - "Start:   sudo /usr/local/bin/k3s-service.sh start"
      - "Stop:    sudo /usr/local/bin/k3s-service.sh stop"
      - "Restart: sudo /usr/local/bin/k3s-service.sh restart"
      - "Status:  sudo /usr/local/bin/k3s-service.sh status"
      - ""
      - "Logs: /var/log/k3s.log"
      - ""
      - "k3s will auto-start when you open a new shell"
      - "==========================================="
